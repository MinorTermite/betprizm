name: Update Matches Every 5 Hours

on:
  schedule:
    - cron: '0 */5 * * *'  # –ö–∞–∂–¥—ã–µ 5 —á–∞—Å–æ–≤
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  sync-from-sheets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Sync from Google Sheets
        run: |
          python << 'EOF'
          import json
          import datetime
          import re
          import csv
          import urllib.request
          
          SHEET_ID = "1QkVj51WMKSd6-LU4vZK3dYPk6QLQIO014ydpACtThNk"
          CSV_URL = f"https://docs.google.com/spreadsheets/d/{SHEET_ID}/export?format=csv&gid=0"
          
          SPORT_MAPPING = {
              '–õ–∏–≥–∞ —á–µ–º–ø–∏–æ–Ω–æ–≤ –£–ï–§–ê': 'football',
              '–õ–∏–≥–∞ –ï–≤—Ä–æ–ø—ã –£–ï–§–ê': 'football',
              '–ê–Ω–≥–ª–∏—è. –ü—Ä–µ–º—å–µ—Ä-–ª–∏–≥–∞': 'football',
              '–†–æ—Å—Å–∏—è. –ü—Ä–µ–º—å–µ—Ä-–ª–∏–≥–∞': 'football',
              '–†–æ—Å—Å–∏—è. –ö—É–±–æ–∫': 'football',
              '–ö–•–õ': 'hockey',
              '–ù–•–õ': 'hockey',
              'NHL': 'hockey',
              'NBA': 'basket',
              '–ï–≤—Ä–æ–ª–∏–≥–∞': 'basket',
              'Dota 2': 'esports',
              'CS2': 'esports',
          }
          
          def norm(s):
              return (s or "").strip()
          
          def detect_sport(league):
              league_lower = league.lower()
              for key, sport in SPORT_MAPPING.items():
                  if league.startswith(key):
                      return sport
              if any(k in league_lower for k in ['—Ñ—É—Ç–±–æ–ª', '–ª–∏–≥–∞', '–ø—Ä–µ–º—å–µ—Ä', '–∫—É–±–æ–∫', 'uefa', '—É–µ—Ñ–∞']):
                  return 'football'
              if any(k in league_lower for k in ['—Ö–æ–∫–∫–µ–π', '–∫—Ö–ª', '–Ω—Ö–ª', 'hockey']):
                  return 'hockey'
              if any(k in league_lower for k in ['–±–∞—Å–∫–µ—Ç', 'nba', '–µ–≤—Ä–æ–ª–∏–≥–∞']):
                  return 'basket'
              if any(k in league_lower for k in ['dota', 'cs', '–∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç', 'esports']):
                  return 'esports'
              return 'football'
          
          print("üì• Loading data from Google Sheets...")
          with urllib.request.urlopen(CSV_URL) as response:
              content = response.read().decode('utf-8')
          
          print("üîÑ Processing data...")
          matches = []
          lines = content.strip().split('\n')
          reader = csv.reader(lines)
          next(reader, None)
          
          for row in reader:
              if len(row) < 12:
                  continue
              
              league = norm(row[0])
              match_id = norm(row[1])
              date = norm(row[2])
              time = norm(row[3])
              team1 = norm(row[4])
              team2 = norm(row[5])
              
              if not league or not team1 or not team2:
                  continue
              
              team1_clean = re.sub(r'\d{1,2}\s+\w{3}\s+\d{1,2}:\d{2}', '', team1).strip()
              team2_clean = re.sub(r'\d{1,2}\s+\w{3}\s+\d{1,2}:\d{2}', '', team2).strip()
              
              p1 = norm(row[6]) or "0.00"
              x = norm(row[7]) or "0.00"
              p2 = norm(row[8]) or "0.00"
              p1x = norm(row[9]) or "0.00"
              p12 = norm(row[10]) or "0.00"
              px2 = norm(row[11]) or "0.00"
              
              sport = detect_sport(league)
              
              match = {
                  "sport": sport,
                  "league": league,
                  "id": match_id,
                  "date": date,
                  "time": time,
                  "team1": team1_clean or team1,
                  "team2": team2_clean or team2,
                  "p1": p1,
                  "x": x,
                  "p2": p2,
                  "p1x": p1x,
                  "p12": p12,
                  "px2": px2
              }
              matches.append(match)
          
          data = {
              "last_update": datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
              "matches": matches
          }
          
          with open('matches.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          
          print(f"‚úÖ Processed {len(matches)} matches")
          EOF
      
      - name: Check changes
        id: check
        run: |
          if git diff --quiet matches.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add matches.json
          git commit -m "üîÑ Auto-update matches [$(date +'%Y-%m-%d %H:%M:%S UTC')]"
          git push
      
      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.changed }}" == "true" ]; then
            echo "‚úÖ Matches updated"
          else
            echo "‚ÑπÔ∏è No changes"
          fi
